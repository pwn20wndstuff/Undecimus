#include <errno.h>
#include <string.h>             // strcmp, strerror
#include <sys/utsname.h>        // uname

#include "common.h"             // LOG, kptr_t
#include "machswap_offsets.h"
#import <Foundation/Foundation.h>

static machswap_offsets_t *machswap_offsets[] =
{
    &(machswap_offsets_t)
    {
        .constant =
        {
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x60,
            .proc_task = 0x10,
            .proc_ucred = 0xf8,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x358,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2e8,
            .task_all_image_info_addr = 0x398,
            .task_all_image_info_size = 0x3a0,
        },
        .iosurface =
        {
            .create_outsize = 0xdd0,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(machswap_offsets_t)
    {
        .constant =
        {
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0xbc8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    &(machswap_offsets_t)
    {
        .constant =
        {
            .kernel_image_base = 0xfffffff007004000,
        },
        .struct_offsets =
        {
            .proc_pid = 0x10,
            .proc_task = 0x18,
            .proc_ucred = 0x100,
            .task_vm_map = 0x20,
            .task_bsd_info = 0x368,
            .task_itk_self = 0xd8,
            .task_itk_registered = 0x2f0,
            .task_all_image_info_addr = 0x3a8,
            .task_all_image_info_size = 0x3b0,
        },
        .iosurface =
        {
            .create_outsize = 0x6c8,
            .get_external_trap_for_index = 0xb7,
        },
    },
    NULL,
};

machswap_offsets_t *get_machswap_offsets(void)
{
    if (kCFCoreFoundationVersionNumber >= 1535.12) {
        return machswap_offsets[0];
    } else if (kCFCoreFoundationVersionNumber >= 1445.32) {
        return machswap_offsets[1];
    } else if (kCFCoreFoundationVersionNumber >= 1443.00) {
        return machswap_offsets[2];
    } else {
        LOG("iOS version too low, 11.0 required");
        return NULL;
    }
}
